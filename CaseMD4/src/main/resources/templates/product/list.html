<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>List Products</title>

    <!-- Custom fonts for this template -->
    <link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
            href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
            rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/assets/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="/assets/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/assets/fontawesome-free-6.2.0-web/css/all.css">

    <link rel="stylesheet" href="/assets/css/style-image.css">

    <link rel="stylesheet" href="/assets/css/style.css">

    <link rel="stylesheet" href="/assets/sweet-alert/sweetalert2.min.css">

</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/products">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-laugh-wink"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Pets House</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
            <a class="nav-link" href="/products">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Nav Item - Tables -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
               aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-fw fa-table"></i>
                <span>Table</span>
            </a>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="/products/list">Product Management</a>
                    <a class="collapse-item" href="/products/shop">Pets Shop</a>
                </div>
            </div>
        </li>
        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>

    </ul>

    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">

            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                <!-- Sidebar Toggle (Topbar) -->
                <form class="form-inline">
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>
                </form>

                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">

                    <!-- Nav Item - Search Dropdown (Visible Only XS) -->
                    <li class="nav-item dropdown no-arrow d-sm-none">
                        <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <!-- Dropdown - Messages -->
                        <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                             aria-labelledby="searchDropdown">
                            <form class="form-inline mr-auto w-100 navbar-search">
                                <div class="input-group">
                                    <input type="text" class="form-control bg-light border-0 small"
                                           placeholder="Search for..." aria-label="Search"
                                           aria-describedby="basic-addon2">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button">
                                            <i class="fas fa-search fa-sm"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </li>

                    <!-- Nav Item - User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small" th:text="${username}"></span>
                            <img class="img-profile rounded-circle"
                                 src="/assets/img/undraw_profile.svg">
                        </a>
                        <!-- Dropdown - User Information -->
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                             aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="/logout" data-toggle="modal" data-target="#logoutModal">
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                Logout
                            </a>
                        </div>
                    </li>

                </ul>

            </nav>
            <!-- End of Topbar -->

            <!-- Begin Page Content -->
            <div class="container-fluid">

                <h1>List Product</h1>
                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <a class="btn btn-outline-success-light create-modal" id="btnShowCreateModal">
                            <i class="fa-solid fa-plus"></i>
                            <span>Add New Product</span>
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="tbListProducts" class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Avatar</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Description</th>
                                    <th colspan="2">Action</th>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <th:block th:replace="/product/modalCreate :: modalCreate"/>

            <th:block th:replace="/product/modalUpdate :: modalUpdate"/>

            <!-- /.container-fluid -->

        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Your Website 2020</span>
                </div>
            </div>
        </footer>
        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>


<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <a class="btn btn-primary" href="/logout">Logout</a>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="/layout/script-list-product :: script-list-product"></th:block>

<script>

    const page = {
        urls: {
            getAllProducts: AppBase.API_PRODUCT,
            saveNewProduct: AppBase.API_PRODUCT,
            getProductById: AppBase.API_PRODUCT,
            deleteProduct: AppBase.API_PRODUCT,
            updateProduct: AppBase.API_PRODUCT,
        },
        elements: {},
        loadData: {},
        commands: {},
        dialogs: {
            elements: {},
            loadData: {},
            commands: {},
            alertDanger: {}
        },
        initializeEventControl: {}
    }

    let renderProducts = (item, productAvatar) => {
        return `
            <tr id="tr_${item.id}">
                <td>${item.id}</td>
                <td>
                    <img src="${AppBase.CLOUDINARY_URL + '/' + AppBase.CLOUDINARY_SCALE_120_100 + '/' + "product_images" + '/' + productAvatar.fileName}" alt="" />
                </td>
                <td>${item.productName}</td>
                <td class="text-right">
                            ${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(item.price)}
                </td>
                <td>${item.quantity}</td>
                <td>${item.description}</td>
                <td class="text-center">
                    <button data-id="${item.id}"
                        data-avatar-id = "${productAvatar.id}"
                        data-avatar-file-folder = "${productAvatar.fileFolder}"
                        data-avatar-file-name = "${productAvatar.fileName}"
                        class="btn btn-outline-primary update">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <button data-id="${item.id}"
                        class="btn btn-outline-danger delete">
                            <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    let product = new Product();
    let productAvatar = new ProductAvatar();

    page.elements.btnShowCreateModal = $('#btnShowCreateModal');

    page.elements.tbProductBody = $('#tbListProducts tbody');

    page.dialogs.elements.modalCreateProduct = $('#modalCreateProduct');
    page.dialogs.elements.modalUpdateProduct = $('#modalUpdateProduct');

    page.elements.loader = $(".loader");
    page.dialogs.elements.productName = $("#productName");
    page.dialogs.elements.productPrice = $("#productPrice");
    page.dialogs.elements.productQuantity = $("#productQuantity");
    page.dialogs.elements.productDesc = $("#description");

    page.dialogs.elements.titleUp = $("#titleUp");
    page.dialogs.elements.priceUp = $("#priceUp");
    page.dialogs.elements.quantityUp = $("#quantityUp");
    page.dialogs.elements.descriptionUp = $("#descriptionUp");
    page.dialogs.elements.btnUpdateProduct = $("#btnUpdateProduct");

    page.dialogs.elements.wrapper = $("section .wrapper");
    page.dialogs.elements.wrapperContent = $("section .wrapper .content");
    page.dialogs.elements.imagePreview = $("#modalCreateProduct section .image-preview canvas");
    page.dialogs.elements.imagePreview.css("display", "none");
    page.dialogs.elements.canvas = $("#canvas");
    page.dialogs.elements.context = page.dialogs.elements.canvas[0].getContext('2d');
    page.dialogs.elements.frmUpdateProduct = $("#frmUpdateProduct");


    page.dialogs.elements.wrappers = $("#modalUpdateProduct section .wrapper");
    page.dialogs.elements.wrapperContents = $("#modalUpdateProduct section .wrapper .content");
    page.dialogs.elements.imagePreviewUp = $("#modalUpdateProduct section .image-preview canvas");
    page.dialogs.elements.imagePreviewUp.css("display", "none");
    page.dialogs.elements.canvasUp = $("#canvasUp");
    page.dialogs.elements.contextUp = page.dialogs.elements.canvasUp[0].getContext('2d');
    page.dialogs.elements.contexts = page.dialogs.elements.canvasUp[0].getContext('2d');

    page.dialogs.elements.divImagePreview = $("#frmCreateProduct div.image-preview, div.file-name");

    page.dialogs.elements.divImagePreviewUp = $("#frmUpdateProduct div.image-preview, div.file-name");

    page.dialogs.elements.imageFileUp = $("#imageFileUp");

    page.dialogs.elements.imageFile = $("#imageFile");
    page.dialogs.elements.btnClearImagePreview = $(".clear-image-preview i");

    page.dialogs.elements.btnCreateProduct = $("#btnCreateProduct");

    page.dialogs.elements.frmCreateProduct = $("#frmCreateProduct");

    page.dialogs.alertDanger.modalCreateProduct = $("#modalCreateProduct .modal-body .modal-alert-danger");
    page.dialogs.alertDanger.modalUpdateProduct = $("#modalUpdateProduct .modal-body .modal-alert-danger");

    page.dialogs.elements.btnClearImagePreviewUp = $(".clear-image-previewUp i");



    page.commands.getAllProducts = () => {
        $.ajax({
            type: "GET",
            url: page.urls.getAllProducts
        })
            .done((data) => {
                $.each(data, (i, item) => {
                    product = item;
                    productAvatar = product.productAvatar;
                    page.elements.tbProductBody.prepend(renderProducts(product, productAvatar));
                    page.commands.removeHandleShowModal();
                    page.commands.handleGroupShowModal();
                })
            })
            .fail((jqXHR) => {
                AppBase.showAlertError(AppBase.AlertMessageEn.ERROR_LOADING_PRODUCT);
            })
    }



    page.commands.handleShowCreateModal = () => {
        page.elements.btnShowCreateModal.on("click", () => {
            page.dialogs.elements.modalCreateProduct.modal("show");
        })
    }


    page.commands.handleShowUpdateModal = () => {
        $(".update").on("click", function () {
            let id = $(this).data("id");
            let avatarFileFolder = $(this).data("avatar-file-folder");
            let avatarFileName = $(this).data("avatar-file-name");

            page.commands.getProductById(id).done((data) => {
                let avatarUrl = AppBase.CLOUDINARY_URL + "/" + AppBase.CLOUDINARY_SCALE_450_350 + "/" + avatarFileFolder + "/" + avatarFileName;
                page.dialogs.commands.loadImageToCanvasUp(null, "", avatarUrl);
                product = data;
                productAvatar = product.productAvatar;
                page.dialogs.elements.titleUp.val(product.productName);
                page.dialogs.elements.priceUp.val(product.price);
                page.dialogs.elements.quantityUp.val(product.quantity);
                page.dialogs.elements.descriptionUp.val(product.description);
                page.dialogs.elements.modalUpdateProduct.modal('show');
            })
        })
    }

    page.dialogs.elements.frmUpdateProduct.validate({
        rules: {
            titleUp: {
                required: true,
                minlength: 5,
                maxlength: 50
            },
            priceUp: {
                required: true,
                min: 100,
                max: 999999999,
                number: true
            },
            quantityUp: {
                required: true,
                min: 1,
                max: 999999,
                number: true
            },
            descriptionUp: {
                required: true,
                minlength: 5,
                maxlength: 200
            }
        },
        messages: {
            titleUp: {
                required: "Vui lòng nhập tên sản phẩm.",
                minlength: "Tên sản phẩm có độ dài tối thiểu là 5 ký tự.",
                maxlength: "Tên sản phẩm có độ dài tối đa là 100 ký tự."
            },
            priceUp: {
                required: "Vui lòng nhập giá.",
                min: "Giá sản phẩm tối thiểu là 100.000 $.",
                max: "Giá sản phẩm tối đa là 999.999.999 $.",
                number: "Giá sản phẩm phải là số."
            },
            quantityUp: {
                required: "Vui lòng nhập số lượng.",
                min: "Số lượng tối thiểu là 1 sản phẩm.",
                max: "Số lượng tối thiểu là 999.999 sản phẩm.",
                number: "Số lượng phải là số."
            },
            descriptionUp: {
                required: "Vui lòng nhập mô tả.",
                minlength: "Mô tả có độ dài tối thiểu là 5 ký tự.",
                maxlength: "Mô tả có độ dài tối đa là 200 ký tự."
            }
        },
        errorLabelContainer: "#modalUpdateProduct .modal-body .modal-alert-danger",
        errorPlacement: function (error) {
            error.appendTo("#modalUpdateProduct .modal-body .modal-alert-danger");
        },
        showErrors: function () {
            if (this.numberOfInvalids() > 0) {
                page.dialogs.alertDanger.modalUpdateProduct.removeClass("hide").addClass("show");
            } else {
                page.dialogs.alertDanger.modalUpdateProduct.removeClass("show").addClass("hide").empty();
                $("#modalCreateCustomer input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            product.productName = page.dialogs.elements.titleUp.val();
            product.price = page.dialogs.elements.priceUp.val();
            product.quantity = page.dialogs.elements.quantityUp.val();
            product.description = page.dialogs.elements.descriptionUp.val();
            console.log(product)
            let formData = new FormData();
            formData.append("productName", product.productName);
            formData.append("price", product.price);
            formData.append("quantity", product.quantity);
            formData.append("description", product.description);
            formData.append("file", page.dialogs.elements.imageFileUp[0].files[0]);

            page.commands.doUpdateProduct(formData);
        }
    })

    page.commands.doUpdateProduct = (formData) => {
        page.commands.showLoading();
        $.ajax({
            type: "PATCH",
            contentType: false,
            cache: false,
            processData: false,
            url: page.urls.updateProduct + "/update/" + product.id,
            data: formData
        })
            .done((data) => {
                product = data;
                productAvatar = product.productAvatar;
                let str =renderProducts(product, productAvatar);
                let updateRow = $("#tr_" + product.id);
                console.log(str)
                updateRow.replaceWith(str);

                AppBase.showAlertSuccess(AppBase.AlertMessageVi.SUCCESS_UPDATED);

                page.commands.removeHandleShowModal();

                page.commands.handleGroupShowModal();
                page.dialogs.elements.modalUpdateProduct.modal("hide");
            }).fail((jqXHR) => {
            let errors = jqXHR.responseJSON;
            if (errors) {
                let str = "";
                $.each(errors, (k, v) => {
                    str += `
                            <label class="error" for="${k + 'Cre'}">${v}</label>
                        `;
                })
                page.dialogs.alertDanger.modalUpdateProduct.removeClass("hide").addClass("show");
                page.dialogs.alertDanger.modalUpdateProduct.css("display", "block")
                page.dialogs.alertDanger.modalUpdateProduct.append(str);
            }
        }).always(function () {
            page.commands.closeLoading();
        })
    }

    page.commands.showLoading = () => {
        page.elements.loader.removeClass("hide");
        page.dialogs.elements.btnUpdateProduct.prop('disabled', true);
    }

    page.commands.closeLoading = () => {
        page.elements.loader.addClass("hide");
        page.dialogs.elements.btnUpdateProduct.prop('disabled', false);
    }


    page.dialogs.commands.loadImageToCanvasUp = (imageFile, fileType, imageUrl) => {
        page.dialogs.elements.imagePreviewUp.css("display", "");
        page.dialogs.elements.wrappers.addClass("active");
        page.dialogs.elements.wrapperContents.css("opacity", 0);

        let imageObj = new Image();
        imageObj.onload = function () {
            page.dialogs.elements.contextUp.canvas.width = imageObj.width;
            page.dialogs.elements.contextUp.canvas.height = imageObj.height;
            page.dialogs.elements.contexts.drawImage(imageObj, 0, 0, imageObj.width, imageObj.height);
        };

        if (fileType === "BINARY") {
            imageObj.src = URL.createObjectURL(imageFile);
        } else {
            imageObj.src = imageUrl;
        }

    }

    page.dialogs.commands.changeImagePreviewUp = () => {
        let imageFile = page.dialogs.elements.imageFileUp[0].files[0];
        if (imageFile) {
            let reader = new FileReader();
            reader.readAsDataURL(imageFile);
            reader.onload = function (e) {
                if (e.target.readyState === FileReader.DONE) {
                    page.dialogs.commands.loadImageToCanvasUp(imageFile, "BINARY", null);
                }
            }
        } else {
            page.dialogs.elements.clearImagePreviewUp();
        }
    }

    page.dialogs.elements.clearImagePreviewUp = () => {
        page.dialogs.elements.imageFileUp.val("");
        page.dialogs.elements.imagePreviewUp.css("display", "none");
        page.dialogs.elements.wrappers.removeClass("active");
        page.dialogs.elements.wrapperContents.css("opacity", 1);
    }

    page.dialogs.commands.handleCloseCreateModal = () => {
        page.dialogs.elements.frmCreateProduct.find("input.error").removeClass("error");
        page.dialogs.elements.frmCreateProduct[0].reset();
        page.dialogs.elements.frmCreateProduct.validate().resetForm();
        page.dialogs.elements.clearImagePreview();
    }


    page.dialogs.commands.handleShowImageInputDialog = () => {
        page.dialogs.elements.divImagePreview.on("click", function () {
            page.dialogs.elements.imageFile.trigger("click");
        });
    }

    page.dialogs.commands.loadImageToCanvas = (imageFile) => {
        page.dialogs.elements.imagePreview.css("display", "");
        page.dialogs.elements.wrapper.addClass("active");
        page.dialogs.elements.wrapperContent.css("opacity", 0);

        let imageObj = new Image();

        imageObj.onload = function () {
            page.dialogs.elements.context.canvas.width = imageObj.width;
            page.dialogs.elements.context.canvas.height = imageObj.height;
            page.dialogs.elements.context.drawImage(imageObj, 0, 0, imageObj.width, imageObj.height);
        };
        imageObj.src = URL.createObjectURL(imageFile)
    }


    page.dialogs.commands.changeImagePreview = () => {
        let imageFile = page.dialogs.elements.imageFile[0].files[0];
        if (imageFile) {
            let reader = new FileReader();

            reader.readAsDataURL(imageFile);

            reader.onload = function(e){
                if (e.target.readyState === FileReader.DONE) {
                    page.dialogs.commands.loadImageToCanvas(imageFile);
                }
            }
        } else {
            page.dialogs.elements.clearImagePreview();
        }
    }

    page.dialogs.elements.clearImagePreview = () => {
        page.dialogs.elements.imageFile.val("");
        page.dialogs.elements.imagePreview.css("display", "none");
        page.dialogs.elements.wrapper.removeClass("active");
        page.dialogs.elements.wrapperContent.css("opacity", 1);
    }

    page.dialogs.elements.frmCreateProduct.validate({
        rules: {
            productName: {
                required: true,
                minlength: 5,
                maxlength: 50
            },
            productPrice: {
                required: true,
                min: 100,
                max: 999999999,
                number: true,

            },
            productQuantity: {
                required: true,
                number: true,
                min: 1,
            },
            description: {
                required: true,
                minlength: 5,
                maxlength: 200
            }
        },
        messages: {
            productName: {
                required: "Vui lòng nhập tên sản phẩm!",
                minlength: "Tên sản phẩm có lớn hơn ${0} ký tự!",
                maxlength: "Tên sản phẩm không vượt quá ${0} ký tự!"
            },
            productPrice: {
                required: "Vui lòng nhập giá sản phẩm!",
                number: "Giá sản phẩm là số!",
                min: "Giá không được thấp hơn ${0}!",
                length: "Giá không được cao hơn ${0}!"
            },
            productQuantity: {
                required: "Vui lòng nhập số lượng!",
                number: "Số lượng sản phẩm là số!",
                min: "Số lượng phải lớn hơn ${0}!",
            },
            description: {
                required: "Vui lòng nhập mô tả!",
                minlength: "Mô tả phải nhiều hơn ${0} ký tự!",
                maxlength: "Mô tả phải ít hơn ${0} ký tự!"
            }
        },
        errorLabelContainer: "#modalCreateProduct .modal-body .modal-alert-danger",
        errorPlacement: function (error) {
            error.appendTo("#modalCreateProduct .modal-body .modal-alert-danger");
        },
        showErrors: function () {
            if (this.numberOfInvalids() > 0) {
                page.dialogs.alertDanger.modalCreateProduct.removeClass("hide").addClass("show");
            } else {
                page.dialogs.alertDanger.modalCreateProduct.removeClass("show").addClass("hide").empty();
                $("#modalCreateProduct input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            product.productName = page.dialogs.elements.productName.val();
            product.price = page.dialogs.elements.productPrice.val();
            product.quantity = page.dialogs.elements.productQuantity.val();
            product.description = page.dialogs.elements.productDesc.val();

            let formData = new FormData();
            formData.append("productName", product.productName);
            formData.append("price", product.price);
            formData.append("quantity", product.quantity);
            formData.append("description", product.description);
            formData.append("file", page.dialogs.elements.imageFile[0].files[0]);

            page.dialogs.commands.createProduct(formData);
        }
    })


    page.dialogs.commands.createProduct = () => {

        let formData = new FormData();
        formData.append("productName", product.productName);
        formData.append("price", product.price);
        formData.append("quantity", product.quantity);
        formData.append("description", product.description);
        formData.append("file", page.dialogs.elements.imageFile[0].files[0]);
        page.dialogs.elements.btnCreateProduct.prop("disabled", true);

        $.ajax({
            type: "POST",
            contentType: false,
            cache: false,
            processData: false,
            url: page.urls.saveNewProduct,
            data: formData
        }).done((data) => {
            product = data;
            productAvatar = product.productAvatar;
            let str = renderProducts(product, productAvatar);
            page.elements.tbProductBody.prepend(str);

            page.dialogs.elements.clearImagePreview();
            page.commands.removeHandleShowModal();
            page.commands.handleGroupShowModal();
            page.dialogs.commands.handleCloseCreateModal();
            page.dialogs.elements.clearImagePreview();
            AppBase.showAlertSuccess(AppBase.AlertMessageEn.SUCCESS_CREATED);

            page.dialogs.alertDanger.frmCreateProduct.removeClass("hide").addClass("show");
            page.dialogs.alertDanger.frmCreateProduct.css("display", "block");
            page.dialogs.alertDanger.frmCreateProduct.append(str);

            page.dialogs.elements.modalCreateProduct.modal('hide');

        }).fail((jqXHR) => {
            let errors = jqXHR.responseJSON;
            if (errors) {
                let str = "";
                $.each(errors, (k, v) => {
                    str += `
                            <label class="error" for="${k + 'Cre'}">${v}</label>
                        `;
                })
                page.dialogs.alertDanger.modalCreateProduct.removeClass("hide").addClass("show");
                page.dialogs.alertDanger.modalCreateProduct.css("display", "block")
                page.dialogs.alertDanger.modalCreateProduct.append(str);
            }
        }).always(function () {
            page.dialogs.elements.btnCreateProduct.prop("disabled", false);
        });
    }

    page.dialogs.elements.btnCreateProduct.on("click", () => {
        page.dialogs.elements.frmCreateProduct.submit();
    })

    page.commands.handleShowConfirmDelete = () => {
        $(".delete").on("click", function () {
            let id = $(this).data("id");
            console.log(id);
            page.commands.getProductById(id).then(() => {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        page.commands.doDeleteProduct(id)
                    }
                })
            })
        });
    }

    page.commands.doDeleteProduct = (productId) => {
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "DELETE",
            url: page.urls.deleteProduct + "/" + productId,
            data: JSON.stringify(productId)
        })
            .done(() => {
                $("#tr_" + productId).remove();
                AppBase.showAlertSuccess(AppBase.AlertMessageVi.SUCCESS_DELETE);

                page.commands.removeHandleShowModal();
                page.commands.handleGroupShowModal();
            })
            .fail((jqXHR) => {
                if (jqXHR.status === 401) {
                    AppBase.showError401();
                } else {
                    if (jqXHR.status === 403) {
                        AppBase.showError403();
                    } else {
                        if (jqXHR.responseJSON.message) {
                            console.log(jqXHR.responseJSON.message)
                            AppBase.showAlertError(jqXHR.responseJSON.message);
                        } else {
                            AppBase.showError500();
                        }
                    }
                }
            })
    }



    page.commands.getProductById = (productId) => {
        return $.ajax({
            type: "GET",
            url: page.urls.getProductById + "/" + productId
        }).done((data) => {
            product = data;
        })
        .fail((jqXHR) => {
            let errors = jqXHR.responseJSON;
            if (errors) {
                let str = "";
                $.each(errors, (k, v) => {
                    str += `
                        ${v}
                    `;
                })
                AppBase.showAlertError(str);
            }
        })
    }



    page.dialogs.commands.handleCloseUpdateModal = () => {
        page.dialogs.elements.frmUpdateProduct.find("input.error").removeClass("error");
        page.dialogs.elements.frmUpdateProduct[0].reset();
        page.dialogs.elements.frmUpdateProduct.validate().resetForm();
        page.dialogs.elements.clearImagePreview();
    }
    page.commands.handleGroupShowModal= () => {
        page.commands.handleShowCreateModal();

        page.commands.handleShowConfirmDelete();

        page.commands.handleShowUpdateModal();
    }

    page.commands.removeHandleShowModal = () => {
        page.elements.btnShowCreateModal.off("click");
        $(".delete").off("click");
        $(".update").off("click");
    }


    page.commands.loadData = () => {
        page.commands.getAllProducts();
    }

    page.commands.initializeEventControl = () => {
        page.dialogs.elements.btnUpdateProduct.on("click", () => {
            page.dialogs.elements.frmUpdateProduct.submit();
        });

        page.commands.handleGroupShowModal();

        page.dialogs.commands.handleShowImageInputDialog();


        page.dialogs.elements.imageFile.on("change", function () {
            page.dialogs.commands.changeImagePreview();
        });

        page.dialogs.elements.btnClearImagePreview.on("click", function () {
            page.dialogs.elements.clearImagePreview();
        });


        page.dialogs.elements.modalUpdateProduct.on("hide.bs.modal", function () {
            page.dialogs.commands.handleCloseUpdateModal();
        });
        page.dialogs.elements.imageFileUp.on("change", function () {
            page.dialogs.commands.changeImagePreview();
        });

        page.dialogs.elements.imageFileUp.on("change", function () {
            page.dialogs.commands.changeImagePreviewUp();
        });
        page.dialogs.elements.divImagePreviewUp.on("click", function () {
            page.dialogs.elements.imageFileUp.trigger("click");
        });
    }

    $(() => {
        page.commands.loadData();

        page.commands.initializeEventControl();
    })
</script>

</body>

</html>